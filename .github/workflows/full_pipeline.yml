# .github/workflows/full_pipeline.yml
name: Full SF Crime Pipeline
on:
  schedule:
    - cron: "0 14,15 * * *" # SF 07:00: 14:00 UTC (yaz), 15:00 UTC (kış)
  workflow_dispatch:
    inputs:
      persist:
        description: "Sonuçları nasıl saklayalım?"
        type: choice
        options: [artifact, commit, none]
        default: artifact
      force:
        description: "Manuel tetiklemede 07:00 kapısını YOK SAY"
        type: boolean
        default: true
      top_k:
        description: "Stacking: her saat dilimi için önerilecek GEOID sayısı"
        default: "50"

permissions:
  actions: read
  contents: write

concurrency:
  group: full-pipeline-${{ github.ref }}
  cancel-in-progress: true

env:
  CRIME_DATA_DIR: crime_prediction_data

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS objects
        run: |
          git lfs install
          git lfs pull
          echo "Repo root:"; ls -lah
          echo "crime_prediction_data:"; ls -lah crime_prediction_data || true
          echo "CRIME_DATA_DIR:"; ls -lah "${CRIME_DATA_DIR}" || true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install pandas

      - name: Read sf_crime.csv from crime_prediction_data
        env:
          CRIME_DATA_DIR: ${{ env.CRIME_DATA_DIR }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, pandas as pd, pathlib
          base = os.environ.get("CRIME_DATA_DIR","crime_prediction_data")
          candidates = [
            pathlib.Path(base)/"sf_crime.csv",
            pathlib.Path("sf_crime.csv")
          ]
          p = next((str(c) for c in candidates if c.exists()), None)
          if not p:
            print("❌ sf_crime.csv bulunamadı. Beklenen konum: crime_prediction_data/sf_crime.csv", file=sys.stderr)
            sys.exit(2)
          df = pd.read_csv(p, low_memory=False)
          print(f"✅ Okundu: {p} | rows={len(df)} | cols={df.shape[1]}")
          print("---- İlk 5 satır ----")
          print(df.head().to_string(index=False))
          PY

      - name: Upload artifact (sf_crime.csv)
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.persist == 'artifact') }}
        uses: actions/upload-artifact@v4
        with:
          name: sf-crime-only
          path: |
            ${{ env.CRIME_DATA_DIR }}/sf_crime.csv
          if-no-files-found: error
          retention-days: 14
